<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Dashboard • Gifté+</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #fff5f7, #ffe4ec, #ffd5e3); }
    .card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .btn-gradient { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); }
    .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,107,107,0.3); }
    .status-verified { background: #d4edda; color: #155724; }
    .status-unverified { background: #f8d7da; color: #721c24; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 50px; color: white; font-weight: 600; z-index: 9999; opacity: 0; transition: all 0.4s; }
    .toast.show { opacity: 1; bottom: 40px; }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); }
    input:checked + .slider:before { transform: translateX(26px); }
  </style>
</head>
<body class="min-h-screen">

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-pink-600">Gifté+</h1>
      <div class="flex items-center gap-4">
        <span class="text-sm text-gray-600">Welcome, <strong id="userEmailHeader" class="text-pink-600">—</strong></span>
        <button onclick="signOutUser()" class="bg-gradient-to-r from-pink-400 to-yellow-300 text-white px-5 py-2 rounded-full font-semibold shadow-md hover:scale-105 transition">
          Sign Out
        </button>
      </div>
    </div>
  </header>

  <div class="max-w-4xl mx-auto px-6 py-12">

    <!-- Loading -->
    <div id="loading" class="text-center py-20">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-pink-500 border-t-transparent"></div>
      <p class="mt-4 text-pink-600 font-semibold">Loading your dashboard...</p>
    </div>

    <!-- Main Content (hidden until auth) -->
    <div id="mainContent" class="hidden space-y-8">

      <!-- Profile Card -->
      <div class="card p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <i class="fas fa-user-circle text-pink-500"></i> My Profile
        </h2>
        <div class="space-y-4">
          <div>
            <p class="text-sm text-gray-600">Email Address</p>
            <p class="text-lg font-semibold" id="userEmail">—</p>
          </div>
          <div class="flex items-center gap-4">
            <span id="verifyStatus" class="px-4 py-2 rounded-full text-sm font-bold status-unverified">
              Unverified
            </span>
            <button onclick="sendVerificationEmail()" class="text-pink-600 hover:underline font-medium">
              Resend Verification Email
            </button>
          </div>
        </div>
      </div>

      <!-- Security Card -->
      <div class="card p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
          <i class="fas fa-shield-alt text-pink-500"></i> Security
        </h2>

        <!-- Change Email -->
        <div class="mb-6 p-4 bg-gray-50 rounded-xl">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">Change Email Address</p>
              <p class="text-sm text-gray-600">Update your login email</p>
            </div>
            <button onclick="openModal('emailModal')" class="btn-gradient text-white px-5 py-2 rounded-full text-sm font-semibold transition">
              Change
            </button>
          </div>
        </div>

        <!-- Reset Password -->
        <div class="mb-6 p-4 bg-gray-50 rounded-xl">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">Password</p>
              <p class="text-sm text-gray-600">Reset your password</p>
            </div>
            <button onclick="sendPasswordReset()" class="btn-gradient text-white px-5 py-2 rounded-full text-sm font-semibold transition">
              Reset
            </button>
          </div>
        </div>

        <!-- MFA -->
        <div class="p-4 bg-gray-50 rounded-xl">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold">Multi-Factor Authentication (MFA)</p>
              <p class="text-sm text-gray-600" id="mfaStatusText">Disabled</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="mfaToggle" onchange="toggleMFA(this.checked)">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Change Email Modal -->
  <div id="emailModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4">Change Email Address</h3>
      <input type="email" id="newEmail" placeholder="New email" class="w-full px-4 py-3 border rounded-lg mb-4">
      <input type="password" id="currentPass" placeholder="Current password" class="w-full px-4 py-3 border rounded-lg mb-6">
      <div class="flex gap-3">
        <button onclick="closeModal('emailModal')" class="flex-1 py-3 border rounded-lg font-semibold">Cancel</button>
        <button onclick="changeUserEmail()" class="flex-1 btn-gradient text-white py-3 rounded-lg font-semibold">Update</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendEmailVerification, updateEmail, reauthenticateWithCredential, EmailAuthProvider, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD95fHNBVSCl4DPjpfSOrVRYI60pH5_2hE",
      authDomain: "giftte007.firebaseapp.com",
      projectId: "giftte007",
      storageBucket: "giftte007.firebasestorage.app",
      messagingSenderId: "168284349265",
      appId: "1:168284349265:web:d4b30126efc7f52450a970",
      measurementId: "G-KT9R9PBQTF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = user;
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('userEmail').textContent = user.email;
      document.getElementById('userEmailHeader').textContent = user.email;

      // Verification status
      const statusEl = document.getElementById('verifyStatus');
      if (user.emailVerified) {
        statusEl.className = 'px-4 py-2 rounded-full text-sm font-bold status-verified';
        statusEl.innerHTML = 'Verified <i class="fas fa-check-circle ml-1"></i>';
      } else {
        statusEl.className = 'px-4 py-2 rounded-full text-sm font-bold status-unverified';
        statusEl.innerHTML = 'Unverified <i class="fas fa-times-circle ml-1"></i>';
      }

      // MFA status
      const mfaDoc = await getDoc(doc(db, 'mfa', user.uid));
      const mfaEnabled = mfaDoc.exists() && mfaDoc.data().enabled;
      document.getElementById('mfaToggle').checked = mfaEnabled;
      document.getElementById('mfaStatusText').textContent = mfaEnabled ? 'Enabled (SMS)' : 'Disabled';
    });

    window.sendVerificationEmail = () => {
      if (!currentUser) return;
      sendEmailVerification(currentUser).then(() => {
        showToast('Verification email sent!');
      }).catch(err => showToast(err.message, true));
    };

    window.sendPasswordReset = () => {
      sendPasswordResetEmail(auth, currentUser.email).then(() => {
        showToast('Password reset email sent!');
      }).catch(err => showToast(err.message, true));
    };

    window.changeUserEmail = async () => {
      const newEmail = document.getElementById('newEmail').value.trim();
      const password = document.getElementById('currentPass').value;
      if (!newEmail || !password) return showToast('Fill all fields', true);

      try {
        const credential = EmailAuthProvider.credential(currentUser.email, password);
        await reauthenticateWithCredential(currentUser, credential);
        await updateEmail(currentUser, newEmail);
        showToast('Email updated! Check your new inbox.');
        closeModal('emailModal');
        setTimeout(() => location.reload(), 2000);
      } catch (err) {
        showToast(err.message, true);
      }
    };

    window.toggleMFA = async (enabled) => {
      await setDoc(doc(db, 'mfa', currentUser.uid), { enabled }, { merge: true });
      document.getElementById('mfaStatusText').textContent = enabled ? 'Enabled (SMS)' : 'Disabled';
      showToast(enabled ? 'MFA enabled! Check your phone.' : 'MFA disabled');
    };

    window.signOutUser = () => {
      signOut(auth).then(() => window.location.href = 'index.html');
    };

    window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
    window.closeModal = (id) => {
      document.getElementById(id).classList.add('hidden');
      document.getElementById('newEmail').value = '';
      document.getElementById('currentPass').value = '';
    };

    window.showToast = (msg, error = false) => {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.background = error ? '#ef4444' : '#10b981';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 4000);
    };
  </script>
</body>
</html>