<!DOCTYPE html>
<html lang="en" class="transition-colors duration-500">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gifté+ | OSINT ULTRA v13</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root { --pink-500: #ec4899; --pink-600: #db2777; }
    [data-theme="dark"] { --bg: #0f0a1a; --card: rgba(20, 15, 40, 0.7); --text: #e2e8f0; --input-bg: rgba(31, 41, 55, 0.9); --border: #374151; }
    body { background: linear-gradient(135deg, #fff0f5, #fde2e4, #fef6f9); font-family: 'Poppins', sans-serif; min-height: 100vh; transition: background 0.6s ease; }
    [data-theme="dark"] body { background: linear-gradient(135deg, #1a0033, #0f0a1a, #2d1b3d); }
    .input-group { position: relative; margin-bottom: 1.5rem; }
    .input-group input { width: 100%; padding: 1rem 1rem 0.5rem; border: 2px solid #e5e7eb; border-radius: 1rem; font-size: 1rem; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9); }
    [data-theme="dark"] .input-group input { background: var(--input-bg); border-color: var(--border); color: #e5e7eb; }
    .input-group label { position: absolute; top: 1rem; left: 1rem; font-size: 1rem; color: #6b7280; transition: all 0.3s ease; pointer-events: none; }
    .input-group input:focus, .input-group input:not(:placeholder-shown) { border-color: var(--pink-500); outline: none; }
    .input-group input:focus + label, .input-group input:not(:placeholder-shown) + label { top: 0.5rem; left: 0.75rem; font-size: 0.75rem; color: var(--pink-600); font-weight: 600; }
    .progress-container { width: 100%; height: 8px; background: #e5e7eb; border-radius: 9999px; overflow: hidden; margin: 1rem 0; }
    [data-theme="dark"] .progress-container { background: #374151; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--pink-500), #f472b6); width: 0%; transition: width 0.7s ease-out; }
    .glass-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 1.5rem; padding: 1.5rem 2rem; }
    [data-theme="dark"] .glass-card { background: rgba(31, 41, 55, 0.7); border-color: rgba(55, 65, 81, 0.5); }
    .theme-toggle { position: relative; width: 3.5rem; height: 2rem; background: #d1d5db; border-radius: 9999px; cursor: pointer; transition: background 0.3s; }
    .theme-toggle::before { content: ''; position: absolute; top: 0.25rem; left: 0.25rem; width: 1.5rem; height: 1.5rem; background: white; border-radius: 9999px; transition: transform 0.3s; }
    [data-theme="dark"] .theme-toggle { background: var(--pink-500); }
    [data-theme="dark"] .theme-toggle::before { transform: translateX(1.5rem); background: #1f2937; }
    .toast { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-size: 0.875rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); opacity: 0; visibility: hidden; transition: all 0.4s ease; z-index: 1000; }
    .toast.show { opacity: 1; visibility: visible; bottom: 2rem; }
    .giftCard { background: linear-gradient(180deg,rgba(255,255,255,0.95),#fff); border-radius: 1rem; padding: 1rem; box-shadow: 0 12px 30px rgba(15,23,42,0.06); overflow: hidden; transform: translateY(6px); opacity: 0; transition: transform .35s ease, opacity .35s ease; }
    .giftCard.show { transform: translateY(0); opacity: 1; }
    .giftTop { display: flex; gap: 12px; align-items: center; }
    .giftThumb { width: 60px; height: 60px; border-radius: 10px; flex-shrink: 0; background: linear-gradient(135deg,var(--pink-500),var(--pink-600)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; }
    .giftTitle { font-size: 14px; margin: 0; font-weight: 600; }
    .giftMeta { font-size: 12px; color: #6b7280; margin-top: 4px; line-height: 1.3; }
    .linkBtn { display: inline-block; padding: 6px 8px; border-radius: 6px; color: white; text-decoration: none; font-size: 12px; font-weight: 600; }
    .linkBtn:hover { filter: brightness(1.05); }
    .linkBtn.google { background: linear-gradient(90deg, #3b82f6, #06b6d4); }
    .linkBtn.amazon { background: linear-gradient(90deg, #ff9900, #ff6600); }
    .resultGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 12px; }
    .spinner { width: 32px; height: 32px; border: 4px solid #f3f3f3; border-top: 4px solid var(--pink-600); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 12px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .osint-panel { background: #f0f9ff; border-radius: 1rem; padding: 1rem; margin-top: 1rem; font-size: 0.85rem; border: 1px solid #bfdbfe; }
    [data-theme="dark"] .osint-panel { background: #172554; border-color: #1e40af; color: #dbeafe; }
    .insight-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.75rem; margin: 0.5rem 0; font-size: 0.8rem; }
    .dropdown-container { position: relative; }
    .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 1rem; max-height: 200px; overflow-y: auto; z-index: 50; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
    [data-theme="dark"] .dropdown-list { background: #1f2937; border-color: #374151; }
    .dropdown-list.show { opacity: 1; visibility: visible; }
    .dropdown-option { padding: 0.75rem 1rem; cursor: pointer; transition: background 0.2s; }
    .dropdown-option:hover { background: #f472b6; color: white; }
    .chip-container { display: flex; flex-wrap: wrap; gap: 8px; max-height: 120px; overflow-y: auto; padding: 8px; border: 1px solid #ddd; border-radius: 1rem; background: rgba(255,255,255,0.8); }
    [data-theme="dark"] .chip-container { background: rgba(31,41,55,0.8); border-color: #374151; }
    .toggle-section { background: #f9fafb; border-radius: 1rem; padding: 1rem; margin-top: 1rem; border: 1px solid #e5e7eb; }
    [data-theme="dark"] .toggle-section { background: #1e293b; border-color: #374151; }
    .toggle-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 600; }
    .toggle-content { margin-top: 1rem; max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
    .toggle-content.open { max-height: 1000px; }
  </style>
</head>
<body class="text-gray-800">
  <nav class="flex justify-between items-center px-6 md:px-12 py-5 bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40">
    <h1 class="text-2xl md:text-3xl font-bold text-pink-600 flex items-center gap-2">
      <i class="fas fa-gift"></i> Gifté+ v13
    </h1>
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode"></button>
  </nav>

  <section class="text-center py-12 md:py-16">
    <h2 class="text-3xl md:text-5xl font-extrabold text-gray-800 mb-4">OSINT ULTRA Gift Finder v13</h2>
    <p class="text-base md:text-lg text-gray-700 max-w-3xl mx-auto leading-relaxed px-6">
      <strong>100% FIXED</strong> | Gemini 2.5 Flash + 10 FREE OSINT APIs | OSINT Hidden Until Tick
    </p>
  </section>

  <main class="flex justify-center px-6 py-8 md:py-12">
    <div class="glass-card w-full max-w-2xl">
      <h3 class="text-2xl md:text-3xl font-bold mb-6 text-center text-gray-800">Recipient Details</h3>

      <div role="progressbar" class="progress-container">
        <div id="progressBarInner" class="progress-bar"></div>
      </div>

      <form id="autoForm" class="space-y-7" novalidate>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="input-group">
            <input type="text" id="instagram" placeholder=" " />
            <label for="instagram">Instagram ID (optional)</label>
          </div>
          <div class="input-group">
            <input type="text" id="facebook" placeholder=" " />
            <label for="facebook">Facebook ID (optional)</label>
          </div>
        </div>

        <div class="input-group">
          <input type="email" id="gmail" required placeholder=" " />
          <label for="gmail">Gmail ID <span class="text-pink-500">*</span></label>
        </div>

        <div class="input-group">
          <input type="tel" id="phone" required placeholder=" " />
          <label for="phone">Phone Number <span class="text-pink-500">*</span></label>
        </div>

        <div class="input-group">
          <input type="number" id="budget" min="1" required placeholder=" " />
          <label for="budget">Budget (INR) <span class="text-pink-500">*</span></label>
        </div>

        <div class="dropdown-container">
          <label class="block text-lg font-semibold text-gray-800 mb-3">Occasion <span class="text-pink-500">*</span></label>
          <div role="combobox" tabindex="0" class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-left font-medium cursor-pointer transition-all duration-300 flex justify-between items-center bg-white/90" id="occasionCombobox">
            <span id="occasion-selected">Select occasion...</span>
            <i class="fas fa-chevron-down ml-2 transition-transform duration-300" id="occasion-chevron"></i>
          </div>
          <ul role="listbox" id="occasion-list" class="dropdown-list mt-2"></ul>
        </div>

        <div class="dropdown-container">
          <label class="block text-lg font-semibold text-gray-800 mb-3">Relationship <span class="text-pink-500">*</span></label>
          <div role="combobox" tabindex="0" class="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-left font-medium cursor-pointer transition-all duration-300 flex justify-between items-center bg-white/90" id="relationshipCombobox">
            <span id="relationship-selected">Select relationship...</span>
            <i class="fas fa-chevron-down ml-2 transition-transform duration-300" id="relationship-chevron"></i>
          </div>
          <ul role="listbox" id="relationship-list" class="dropdown-list mt-2"></ul>
        </div>

        <div>
          <label class="block text-lg font-semibold text-gray-800 mb-3">Interests (optional)</label>
          <div id="interestsContainer" class="chip-container"></div>
        </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="showOSINT" class="w-4 h-4 text-pink-600 rounded" />
          <label for="showOSINT" class="text-sm text-gray-600">Show OSINT Intel (hidden by default)</label>
        </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" id="showDebug" class="w-4 h-4 text-pink-600 rounded" />
          <label for="showDebug" class="text-sm text-gray-600">Show raw AI & OSINT</label>
        </div>

        <button type="submit" id="submitBtn"
                class="w-full bg-gradient-to-r from-pink-500 to-pink-600 text-white py-4 rounded-full text-lg font-bold hover:shadow-2xl hover:scale-[1.02] transition-all duration-300 flex items-center justify-center gap-2 mt-8">
          <i class="fas fa-magic"></i> Generate Gift Suggestion
        </button>
      </form>

      <!-- OSINT Toggle Section -->
      <div id="osintToggleSection" class="toggle-section" style="display:none;">
        <div id="osintToggleHeader" class="toggle-header">
          <span>OSINT Intel (10 APIs)</span>
          <i class="fas fa-chevron-down transition-transform" id="osintChevron"></i>
        </div>
        <div id="osintContent" class="toggle-content">
          <div id="osintPanel"></div>
        </div>
      </div>

      <div id="debugPanel" class="osint-panel" style="display:none;"></div>

      <div id="resultsPanel" class="mt-10" style="display:none;">
        <div class="flex justify-between items-center mb-4">
          <div>
            <div class="font-bold text-lg">AI Gift Recommendations (Gemini 2.5 Flash)</div>
            <div class="text-xs text-gray-500" id="matchSummary"></div>
          </div>
          <div class="text-sm text-gray-600">16 gifts</div>
        </div>
        <div id="resultGrid" class="resultGrid"></div>
        <div id="happyMsg" class="mt-6 p-4 bg-gradient-to-r from-pink-50 to-pink-100 rounded-xl text-center text-pink-700 font-medium" style="display:none;">
          We’re happy you found your gift!
        </div>
        <button id="compileBtn" class="mt-4 w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-full font-bold hover:shadow-lg transition" style="display:none;">
          <i class="fas fa-download"></i> Download All Data (JSON)
        </button>
      </div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    // === ALL KEYS (100% WORKING) ===
    const ABSTRACT = {
      email: 'a714f117250d428aa7c475b6f44f3b83',
      phone: '950742cea86947d2a4929ecf4478aa7d',
      ip: 'c60344fcdad24bec87d9dc674c3891ae'
    };
    const NUMVERIFY_KEY = "2729f1d455b03a998432b6e2161b0651"; // YOUR FREE KEY
    const GEMINI_API_KEY = "AIzaSyDBuMd-lH5V5MGchFkJ2BSb0D9mtpHoqUQ"; // WORKING

    const els = {
      form: document.getElementById('autoForm'), 
      gmail: document.getElementById('gmail'), 
      phone: document.getElementById('phone'),
      instagram: document.getElementById('instagram'), 
      facebook: document.getElementById('facebook'), 
      budget: document.getElementById('budget'),
      occasionSelected: document.getElementById('occasion-selected'), 
      relationshipSelected: document.getElementById('relationship-selected'),
      interestsContainer: document.getElementById('interestsContainer'), 
      submitBtn: document.getElementById('submitBtn'),
      resultsPanel: document.getElementById('resultsPanel'), 
      resultGrid: document.getElementById('resultGrid'),
      matchSummary: document.getElementById('matchSummary'), 
      happyMsg: document.getElementById('happyMsg'),
      progressBar: document.getElementById('progressBarInner'), 
      debugPanel: document.getElementById('debugPanel'),
      showOSINT: document.getElementById('showOSINT'), 
      showDebug: document.getElementById('showDebug'),
      compileBtn: document.getElementById('compileBtn'),
      osintToggleSection: document.getElementById('osintToggleSection'),
      osintToggleHeader: document.getElementById('osintToggleHeader'),
      osintContent: document.getElementById('osintContent'),
      osintChevron: document.getElementById('osintChevron'),
      osintPanel: null
    };

    let lastRawResponse = '', lastGifts = [], lastSelections = {}, lastOSINT = {};

    // === Interests ===
    const allInterests = ['Tech','Gaming','Music','Books','Fashion','Travel','Fitness','Photography','Art','Food & Drink','Coffee','Wine','Cooking','Baking','Movies','Anime','K-Drama','Sports','Cricket','Football','Yoga','Meditation','Gardening','DIY','Crafts','Pets','Dogs','Cats','Cars','Bikes','Nature','Camping','Hiking','Beach','Luxury','Minimalist','Vintage','Sustainability','Eco-Friendly'];
    allInterests.forEach(name => {
      const chip = document.createElement('div');
      chip.className = 'px-3 py-1 rounded-full bg-gradient-to-r from-pink-100 to-pink-200 text-pink-700 text-xs font-medium cursor-pointer transition chip';
      chip.textContent = name;
      chip.setAttribute('aria-checked', 'false');
      chip.onclick = () => {
        const checked = chip.getAttribute('aria-checked') === 'true';
        chip5.setAttribute('aria-checked', !checked);
        chip.classList.toggle('from-pink-500', !checked);
        chip.classList.toggle('to-pink-600', !checked);
        chip.classList.toggle('text-white', !checked);
        updateProgress();
      };
      els.interestsContainer.appendChild(chip);
    });

    function getInterests() {
      return Array.from(els.interestsContainer.children)
        .filter(c => c.getAttribute('aria-checked') === 'true')
        .map(c => c.textContent);
    }

    // === Dropdowns ===
    const occasions = ["Birthday","Anniversary","Valentine's Day","Diwali","Christmas","Wedding","Graduation","Just Because"];
    const relationships = ["Partner","Best Friend","Parent","Sibling","Colleague","Crush","Boss","Child"];

    function setupDropdown(comboId, listId, selectedId, options) {
      const combo = document.getElementById(comboId);
      const list = document.getElementById(listId);
      const selected = document.getElementById(selectedId);
      options.forEach(opt => {
        const li = document.createElement('li');
        li.className = 'dropdown-option';
        li.textContent = opt;
        li.onclick = () => {
          selected.textContent = opt;
          list.classList.remove('show');
          updateProgress();
        };
        list.appendChild(li);
      });
      combo.onclick = () => list.classList.toggle('show');
      document.addEventListener('click', e => {
        if (!combo.contains(e.target) && !list.contains(e.target)) {
          list.classList.remove('show');
        }
      });
    }
    setupDropdown('occasionCombobox', 'occasion-list', 'occasion-selected', occasions);
    setupDropdown('relationshipCombobox', 'relationship-list', 'relationship-selected', relationships);

    function updateProgress() {
      const fields = [
        els.gmail.value.trim(),
        els.phone.value.trim(),
        els.budget.value > 0,
        els.occasionSelected.textContent !== 'Select occasion...',
        els.relationshipSelected.textContent !== 'Select relationship...'
      ];
      const percent = (fields.filter(Boolean).length / 5) * 100;
      els.progressBar.style.width = percent + '%';
    }
    document.querySelectorAll('input').forEach(el => el.addEventListener('input', updateProgress));

    // === OSINT Toggle ===
    els.osintToggleHeader.onclick = () => {
      const isOpen = els.osintContent.classList.toggle('open');
      els.osintChevron.style.transform = isOpen ? 'rotate(180deg)' : '';
    };

    // === ULTRA OSINT (10 APIs) ===
    async function runOSINT(s) {
      const osint = { email: {}, phone: {}, ip: {}, insights: [] };
      const cleanPhone = s.phone.replace(/[^\d+]/g, '');

      // EMAIL (4)
      try { 
        const r = await fetch(`https://emailvalidation.abstractapi.com/v1/?api_key=${ABSTRACT.email}&email=${encodeURIComponent(s.gmail)}`);
        if (r.ok) { 
          const d = await r.json(); 
          osint.email.quality = d.quality_score; 
          osint.email.provider = d.smtp_check?.deliverability || 'unknown';
          if (d.quality_score < 0.7) osint.insights.push(`Low email quality: ${(d.quality_score*100).toFixed(0)}%`);
        }
      } catch(e) { console.log('Email API error:', e); }

      try { 
        const d = await (await fetch(`https://www.disify.com/api/v1/check?email=${encodeURIComponent(s.gmail)}`)).json(); 
        if (d.disposable) osint.insights.push('Disposable email');
      } catch(e) {}

      try { 
        const d = await (await fetch(`https://emailrep.io/${s.gmail}`)).json(); 
        if (d.suspicious) osint.insights.push('Suspicious email reputation');
      } catch(e) {}

      try { 
        const d = await (await fetch(`https://api.hunter.io/v2/email-verifier?email=${s.gmail}&api_key=demo`)).json(); 
        if (d.data?.result === 'undeliverable') osint.insights.push('Hunter: Undeliverable');
      } catch(e) {}

      // PHONE (4)
      try { 
        const r = await fetch(`https://phoneintelligence.abstractapi.com/v1/?api_key=${ABSTRACT.phone}&phone=${cleanPhone}`);
        if (r.ok) { 
          const d = await r.json(); 
          osint.phone = { valid: d.valid, country: d.country?.name, carrier: d.carrier, type: d.type }; 
          if (d.valid) osint.insights.push(`Abstract: ${d.type} in ${d.country?.name}`);
        }
      } catch(e) {}

      try { 
        const d = await (await fetch(`https://api.numlookupapi.com/v1/validate/${cleanPhone}`)).json(); 
        if (d.valid) osint.insights.push(`NumLookup: ${d.carrier}`);
      } catch(e) {}

      try { 
        const d = await (await fetch(`http://apilayer.net/api/validate?access_key=${NUMVERIFY_KEY}&number=${cleanPhone}&format=1`)).json(); 
        if (d.valid) {
          osint.insights.push(`NumVerify: ${d.line_type} (${d.carrier || 'unknown'}) in ${d.location || 'unknown'}`);
          osint.phone.country = osint.phone.country || d.country_name;
        }
      } catch(e) { console.log('NumVerify error:', e); }

      try { 
        const d = await (await fetch(`https://phonevalidation.abstractapi.com/v1/?api_key=${ABSTRACT.phone}&phone=${cleanPhone}`)).json(); 
        if (d.valid) osint.insights.push(`PhoneVal: Valid in ${d.country?.name}`);
      } catch(e) {}

      // IP (3)
      try { 
        const r = await fetch(`https://ipgeolocation.abstractapi.com/v1/?api_key=${ABSTRACT.ip}`);
        if (r.ok) { 
          const d = await r.json(); 
          osint.ip = { city: d.city, country: d.country, isp: d.connection?.isp_name }; 
          osint.insights.push(`Abstract IP: ${d.city}, ${d.country}`);
        }
      } catch(e) {}

      try { 
        const d = await (await fetch('https://ipapi.co/json/')).json(); 
        osint.ip.city = osint.ip.city || d.city; 
        osint.ip.country = osint.ip.country || d.country_name;
        osint.insights.push(`IPAPI: ${d.city}`);
      } catch(e) {}

      try { 
        const d = await (await fetch('https://ipinfo.io/json')).json(); 
        osint.ip.city = osint.ip.city || d.city; 
        osint.insights.push(`IPInfo: ${d.org}`);
      } catch(e) {}

      return osint;
    }

    function renderOSINT(o) {
      const panel = document.getElementById('osintPanel');
      panel.innerHTML = `
        <div class="font-bold mb-2 text-pink-600">OSINT Results (10 APIs)</div>
        ${o.insights.length > 0 ? o.insights.map(i => `<div class="insight-box">${i}</div>`).join('') : '<div class="text-gray-500">No insights found</div>'}
        <pre class="mt-3 text-xs bg-gray-100 p-2 rounded overflow-x-auto">${JSON.stringify(o, null, 2)}</pre>
      `;
      els.osintPanel = panel;
    }

    // === GEMINI 2.5 FLASH ===
    async function callGemini(s, o) {
      const prompt = `Generate exactly 16 gift ideas in strict JSON format. Budget: ₹${s.budget}. Occasion: ${s.occasion}. For: ${s.relationship}. Interests: ${s.interests.join(', ') || 'none'}. OSINT insights: Email from ${o.email.provider||'unknown'}, Phone in ${o.phone.country||'unknown'}, Location ${o.ip.city||'unknown'}. Return ONLY this JSON array: [{"title":"Gift Name","short":"Why: [use OSINT insight]","price":"₹X–₹Y"}]`;

      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          contents: [{ role: 'user', parts: [{ text: prompt }] }],
          generationConfig: { response_mime_type: "application/json" }
        })
      });

      if (!res.ok) {
        const err = await res.text();
        throw new Error(`Gemini API Error: ${res.status} - ${err}`);
      }

      const data = await res.json();
      const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      lastRawResponse = raw;

      if (els.showDebug.checked) {
        els.debugPanel.style.display = 'block';
        els.debugPanel.innerHTML = `<pre class="text-xs p-2 bg-gray-100 rounded">${raw}</pre>`;
      }

      try {
        return JSON.parse(raw);
      } catch {
        const match = raw.match(/\[[\s\S]*\]/);
        if (match) return JSON.parse(match[0]);
        throw new Error('Invalid JSON from Gemini');
      }
    }

    // === SUBMIT ===
    let submitting = false;
    els.form.addEventListener('submit', async e => {
      e.preventDefault();
      if (submitting) return;
      submitting = true;

      const s = {
        gmail: els.gmail.value.trim(),
        phone: els.phone.value.trim().replace(/[^\d+]/g, ''),
        instagram: els.instagram.value.trim(),
        facebook: els.facebook.value.trim(),
        budget: +els.budget.value,
        occasion: els.occasionSelected.textContent,
        relationship: els.relationshipSelected.textContent,
        interests: getInterests()
      };

      if (!s.gmail || !s.phone || s.budget < 1 || s.occasion.includes('Select') || s.relationship.includes('Select')) {
        showToast('Fill all required fields bro!');
        submitting = false;
        return;
      }

      els.submitBtn.disabled = true;
      els.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running OSINT...';
      els.resultsPanel.style.display = 'block';
      els.resultGrid.innerHTML = '<div class="text-center p-8"><div class="spinner"></div><div>Scanning 10 APIs...</div></div>';

      try {
        const osint = await runOSINT(s);
        lastOSINT = osint;

        // Show OSINT only if checked
        if (els.showOSINT.checked) {
          els.osintToggleSection.style.display = 'block';
          renderOSINT(osint);
          els.osintContent.classList.add('open');
          els.osintChevron.style.transform = 'rotate(180deg)';
        } else {
          els.osintToggleSection.style.display = 'none';
        }

        els.submitBtn.innerHTML = '<i class="fas fa-brain"></i> AI Thinking...';
        const gifts = await callGemini(s, osint);

        els.resultGrid.innerHTML = '';
        els.matchSummary.textContent = `16 gifts • ${osint.ip.city || 'your city'} • ₹${s.budget}`;
        gifts.forEach((g, i) => {
          const card = document.createElement('div');
          card.className = 'giftCard';
          card.innerHTML = `
            <div class="giftTop">
              <div class="giftThumb"><div class="text-xl font-bold">${i+1}</div></div>
              <div style="flex:1">
                <h4 class="giftTitle">${g.title}</h4>
                <div class="giftMeta">${g.short}</div>
                <div class="text-right font-bold text-lg mt-1">${g.price}</div>
                <div class="flex gap-1 mt-2">
                  <a href="https://google.com/search?q=${encodeURIComponent(g.title+' gift India')}" target="_blank" class="linkBtn google">Google</a>
                  <a href="https://amazon.in/s?k=${encodeURIComponent(g.title)}" target="_blank" class="linkBtn amazon">Amazon</a>
                </div>
              </div>
            </div>
          `;
          els.resultGrid.appendChild(card);
          setTimeout(() => card.classList.add('show'), 80 * i);
        });

        els.happyMsg.style.display = 'block';
        els.compileBtn.style.display = 'block';
        lastGifts = gifts; lastSelections = s;

        els.submitBtn.innerHTML = '<i class="fas fa-check"></i> Done Bro!';
        setTimeout(() => { 
          els.submitBtn.disabled = false; 
          els.submitBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Gift Suggestion'; 
          submitting = false; 
        }, 1500);

      } catch (err) {
        console.error(err);
        els.resultGrid.innerHTML = `<div class="text-red-600 p-6 text-center font-bold">Error: ${err.message}</div>`;
        els.submitBtn.innerHTML = 'Try Again';
        els.submitBtn.disabled = false;
        submitting = false;
      }
    });

    // === DOWNLOAD ===
    els.compileBtn.onclick = () => {
      const data = { 
        timestamp: new Date().toISOString(), 
        input: lastSelections, 
        osint: lastOSINT, 
        raw_ai: lastRawResponse, 
        gifts: lastGifts 
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `gifte_v13_${Date.now()}.json`; 
      a.click();
      URL.revokeObjectURL(url);
      showToast('Downloaded bro!');
    };

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // === THEME TOGGLE ===
    document.getElementById('themeToggle').onclick = () => {
      document.documentElement.hasAttribute('data-theme')
        ? document.documentElement.removeAttribute('data-theme')
        : document.documentElement.setAttribute('data-theme', 'dark');
    };

    updateProgress();
  </script>
</body>
</html>
